# Telegram Bot Guide

## Проблема "409 Conflict"

Эта ошибка возникает, когда несколько экземпляров бота пытаются получить обновления от Telegram API одновременно.

## Архитектура решения

### 1. Singleton Pattern с файловой блокировкой

Бот использует паттерн Singleton с дополнительной файловой блокировкой:

- **Lock файл** (`.telegram-bot.lock`) - предотвращает запуск нескольких экземпляров
- **Instance ID** - уникальный идентификатор каждого экземпляра (например: `bot-12345-1234567890`)
- **Автоматическая очистка** - удаление устаревших lock файлов (старше 5 минут)

### 2. Улучшенная инициализация

- Промис-based инициализация предотвращает race conditions
- Увеличенные задержки между попытками (20-30 секунд)
- Максимум 3 попытки запуска с экспоненциальной задержкой

### 3. Расширенный процесс очистки

При остановке бота выполняется:
1. Остановка обработчиков событий
2. Остановка polling
3. Удаление webhook
4. Очистка очереди обновлений
5. Закрытие всех соединений
6. Ожидание 5-10 секунд для полной очистки

## Команды управления

### Проверка статуса
```bash
npm run telegram:status
```
Показывает:
- Состояние lock файла
- Запущенные процессы
- Переменные окружения
- Используемые порты

### Мягкий перезапуск
```bash
npm run telegram:reset
```
Корректно останавливает бота и запускает заново.

### Принудительный сброс
```bash
npm run telegram:force-reset
```
**ВНИМАНИЕ**: Убивает все процессы Node.js!
Используйте только если мягкий перезапуск не помогает.

### Полный перезапуск с очисткой
```bash
npm run restart:force
```
Выполняет принудительный сброс и запускает сервер.

## Устранение неполадок

### Ошибка "409 Conflict" продолжается

1. Проверьте статус:
```bash
npm run telegram:status
```

2. Если есть устаревший lock файл:
```bash
rm .telegram-bot.lock
```

3. Выполните принудительный сброс:
```bash
npm run telegram:force-reset
```

4. Подождите 30 секунд и запустите сервер:
```bash
npm start
```

### Бот не отвечает на команды

1. Проверьте логи сервера на наличие ошибок
2. Убедитесь, что TELEGRAM_BOT_TOKEN установлен в .env
3. Проверьте, что бот не заблокирован в Telegram

### Множественные процессы

Если `npm run telegram:status` показывает несколько процессов:

1. Остановите все процессы:
```bash
pkill -f "node.*server.js"
```

2. Удалите lock файл:
```bash
rm .telegram-bot.lock
```

3. Запустите сервер заново:
```bash
npm start
```

## Переменные окружения

Убедитесь, что в файле `.env` установлены:

```env
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_BOT_USERNAME=YourBotUsername
FRONTEND_URL=https://your-frontend-url.com
```

## Отладка

Для детальной отладки добавьте в `.env`:

```env
DEBUG=telegram:*
```

## Важные файлы

- `/src/services/telegramBot/singleton.js` - Singleton с блокировкой
- `/src/services/telegramBot/bot.js` - Основная логика бота
- `/scripts/check-bot-status.js` - Проверка статуса
- `/scripts/force-reset-telegram.js` - Принудительный сброс
- `.telegram-bot.lock` - Lock файл (создается автоматически)

## Best Practices

1. **Всегда используйте команды npm** для управления ботом
2. **Не запускайте несколько экземпляров** сервера одновременно
3. **Проверяйте статус** перед перезапуском
4. **Ждите 30 секунд** между остановкой и запуском
5. **Мониторьте логи** для раннего обнаружения проблем